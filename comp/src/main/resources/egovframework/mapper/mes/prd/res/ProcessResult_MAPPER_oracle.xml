<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mes.prd.res.service.impl.ProcessResultMapper">
	

	<resultMap id="processResult" type="mes.prd.res.service.ProcessResultVO">
		<result property="movNum" column="MOV_NUM" />
		<result property="prdComNum" column="PRD_COM_NUM" />
		<result property="itmCode" column="ITM_CODE" />
		<result property="lotNum" column="LOT_NUM" />
		<result property="prcComVol" column="PRC_COM_VOL" />
		<result property="prcBckVol" column="PRC_BCK_VOL" />
	</resultMap>
	
	<insert id="insertProcessResult">
		<![CDATA[
			INSERT INTO PROCESS_RESULT 
				( MOV_NUM
				  , PRD_COM_NUM
				  , ITM_CODE
				  , LOT_NUM
				  , PRC_COM_VOL
				  , PRC_BCK_VOL )
			VALUES ( #{movNum}
				  , #{prdComNum}
				  , #{itmCode}
				  , #{lotNum}
				  , #{prcComVol}
				  , #{prcBckVol} )
		]]>
	</insert>
	
	<update id="updateProcessResult">
		<![CDATA[
			UPDATE PROCESS_RESULT
			SET MOV_NUM=#{movNum}
				, PRD_COM_NUM=#{prdComNum}
				, ITM_CODE=#{itmCode}
				, LOT_NUM=#{lotNum}
				, PRC_COM_VOL=#{prcComVol}
				, PRC_BCK_VOL=#{prcBckVol}
						WHERE MOV_NUM=#{movNum}
				]]>
	</update>
	
	<delete id="deleteProcessResult">
		<![CDATA[
			DELETE FROM PROCESS_RESULT 
						WHERE MOV_NUM=#{movNum}
				]]>
	</delete>
	
	<select id="selectProcessResult" resultMap="processResult">
		<![CDATA[
			SELECT
				MOV_NUM
				, PRD_COM_NUM
				, ITM_CODE
				, LOT_NUM
				, PRC_COM_VOL
				, PRC_BCK_VOL
			FROM PROCESS_RESULT
						WHERE MOV_NUM=#{movNum}
				]]>
	</select>
	
	<select id="selectProcessResultList" parameterType="mes.prd.res.service.ProcessResultVO" resultType="mes.prd.res.service.ProcessResultVO">
SELECT * FROM (
	SELECT A.*, ROWNUM RNUM FROM (
				select rownum
				       ,to_char(pcd.prd_com_d_date ,'yyyy-MM-dd') as prd_com_d_date
				       ,pcd.prd_com_num
				       ,prd_com_d_num
				       ,pcd.itm_code
				       ,item.itm_name
				       ,p.prc_name
				       ,prd.prc_res_no
                       ,prd.prc_com_d_vol
                       ,prd.prc_res_vol
                       ,(prd.prc_com_d_vol-prd.prc_res_vol) as prc_n_vol
                       ,pcd.prc_com_div
                       ,prd.prc_res_d_num
                       ,prd.prc_code 
				from produce_command_d pcd
                     , process_result pr
                     , process_result_d prd
                     , item 
                     , process p 
				where pr.prd_com_num = pcd.prd_com_num and
				      item.itm_code=pcd.itm_code and
                      pr.mov_num =prd.mov_num and
                      p.prc_code = prd.prc_code and
                      <![CDATA[
                      pcd.prc_com_y <> 'Y'
                      ]]>
                      <if test="prcCode != null and prcCode !=''" >
                      and prd.prc_code in (${prcCode})
						</if>
				      <if test="prcResDNum != null">
						<![CDATA[	
							and prd.prc_res_d_num < #{prcResDNum}
						]]>
						</if>
						ORDER BY
		prd.prc_res_d_num DESC
		<![CDATA[					
	) A WHERE ROWNUM <=10
)
]]>
	</select>	

	<select id="processResultSelect" parameterType="mes.prd.res.service.ProcessResultVO" resultType="mes.prd.res.service.ProcessResultVO">
SELECT * FROM (
	SELECT A.*, ROWNUM RNUM FROM (
				select 
				       pcd.prd_com_num
				       ,pcd.itm_code
				       ,item.itm_name
                       ,prd.prc_com_d_vol
                       ,prd.prc_res_vol
                       ,om.oper_name
                       ,(prd.prc_com_d_vol-prd.prc_res_vol) as prc_n_vol
				from produce_command_d pcd
                     , process_result_d prd
                     , process_result pr
                     , item 
                     , order_d od
                     , order_m om
				where 
				      item.itm_code=pcd.itm_code and
                      pcd.prd_com_num = pr.prd_com_num and
                      pr.mov_num = prd.mov_num and
                      od.ord_d_num = pcd.ord_d_num and
                      od.ord_num = om.ord_num and
					  prd.prc_res_d_num = #{prcResDNum}

		<![CDATA[					
	) A WHERE ROWNUM <=10
)
]]>

	</select>	
	
	<select id="produceSelect" parameterType="mes.prd.res.service.ProcessResultVO" resultType="mes.prd.res.service.ProcessResultVO">
SELECT * FROM (
	SELECT A.*, ROWNUM RNUM FROM (
				select                 
                       pcm.prd_com_mat_o
				       ,pcm.lot_num
				       ,prd.prc_com_d_vol
				       ,prc_res_vol
				       ,(prd.prc_com_d_vol-prc_res_vol) as prc_n_vol
				       ,prd.prc_err_vol
                       ,pcm.mat_vol
                       ,prd.prc_state
				       ,a.prc_state as prc_f_state
                       
				from 	produce_command_mat pcm,
				     	produce_command_d pcd,
				     	process_result pr,
				     	process_result_d prd,
				     	(select a.*, prd.prc_state from process_result pr, 
                          process_result_d prd,
                          (select max(prc_code) as prc_code,mov_num from process_result_d group by mov_num)a
                          where pr.mov_num = prd.mov_num and
                          pr.mov_num = a.mov_num  and
                          a.prc_code = prd.prc_code)a
				where 	pcd.prd_com_d_num = pcm.prd_com_d_num and
				      	pr.prd_com_num = pcd.prd_com_num and
				      	pr. lot_num = pcm.lot_num and
				      	prd.mov_num = pr.mov_num  and
                        a.mov_num = prd.mov_num and
				      	prd.prc_code = #{prcCode} and
				      	pcd.prd_com_d_num = #{prdComDNum}
		<![CDATA[					
	) A WHERE ROWNUM <=10
)
]]>

	</select>	
	
	
	
	
	<select id="selectProcessResultListTotCnt" parameterType="mes.prd.res.service.ProcessResultVO" resultType="int">
			SELECT COUNT(*) totcnt
			FROM PROCESS_RESULT
			WHERE 1=1
			<if test="searchKeyword != null and searchKeyword != ''">
				<if test="searchCondition == 0">AND
					MOV_NUM = #{searchKeyword}
				</if>
				<if test="searchCondition == 1">AND
					PRD_COM_NUM LIKE '%' || #{searchKeyword} || '%'
				</if>
			</if>
	</select>

</mapper>
