<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper
	namespace="mes.prd.com.service.impl.ProduceCommandDMapper">
	
	<!-- 작업지시 조회 -->
	<select id="selectProduceCommandList"
		parameterType="mes.prd.com.service.ProduceCommandDVO"
		resultType="mes.prd.com.service.ProduceCommandDVO">
		SELECT * FROM (
		SELECT A.*, ROWNUM RNUM FROM (
		select prd_Com_Num , TO_CHAR(prd_Com_Date, 'yyyy-MM-dd') as prd_Com_Date, prd_Com_Name, prd_Com_Note from PRODUCE_COMMAND
		<where>
		<if test="prdComNum1 != null and prdComNum1 != ''">
				<![CDATA[	
					Prd_Com_Num < #{prdComNum1}
				]]>
		</if>
		</where>
		ORDER BY
		PRD_COM_NUM DESC
		
		<![CDATA[					
		) A WHERE ROWNUM <= 10)
		]]>
	</select>
	
	<!-- 작업지시디테일 조회 -->
	<select id="selectProduceCommandDList"
		parameterType="mes.prd.com.service.ProduceCommandDVO"
		resultType="mes.prd.com.service.ProduceCommandDVO">
		
		SELECT * FROM (
		SELECT A.*, ROWNUM RNUM FROM (
		select A.* ,(B.yes_Com_Vol - a.prd_com_vol) as yes_Com_Vol,
		        a.ord_vol - (B.yes_Com_Vol - a.prd_com_vol) - a.ord_out_vol as no_Com_Vol,
		        a.itm_day_output/8 as UPH, a.prd_com_vol/a.itm_day_output as day_Num
		from(select C.*, TO_CHAR(C.prd_com_d_date, 'yyyy-MM-dd') as prd_com_d_date1, I.itm_name, M.mat_name, OD.ord_num, OM.ord_delivery_date, OM.oper_name,
		      OD.ord_vol, OD.ord_out_vol, I.itm_day_output
		      from PRODUCE_COMMAND_d C, item I, order_d OD, order_m  OM, material M
		      where c.prd_com_num = #{prdComNum}
		      	and c.itm_code = i.itm_code
		      	and i.mat_code = m.mat_code
		        and c.ord_d_num = od.ord_d_num (+)
		        and od.ord_num = om.ord_num (+)) A, 
		        (select ord_d_num, sum(prd_com_vol) as yes_Com_Vol
		        from produce_command_d
		        group by ord_d_num) B
		where a.ord_d_num = b.ord_d_num (+)
		<if test="prdComDNum1 != null and prdComDNum1 != ''">
				<![CDATA[	
					and Prd_Com_D_Num > #{prdComDNum1}
				]]>
		</if>
		ORDER BY
		PRD_COM_D_NUM
		
		<![CDATA[					
		) A WHERE ROWNUM <= 10)
		]]>
	</select>
	
	<!-- 작업지시자재 조회 -->
	<select id="selectProduceCommandMatList"
		parameterType="mes.prd.com.service.ProduceCommandDVO"
		resultType="mes.prd.com.service.ProduceCommandDVO">
		SELECT * FROM (
		SELECT A.*, ROWNUM RNUM FROM (
		select *
		from PRODUCE_COMMAND_MAT
		where prd_com_d_num = #{prdComDNum}
		<if test="prdComDNum1 != null and prdComDNum1 != ''">
				<![CDATA[	
					and Prd_Com_Mat_Num > #{prdComMatNum}
				]]>
		</if>
		ORDER BY
		PRD_COM_MAT_NUM
		
		<![CDATA[					
		) A WHERE ROWNUM <= 10)
		]]>
	</select>
	
	<!-- 작업지시공정흐름 조회 -->
	<select id="selectProduceCommandFlowList"
		parameterType="mes.prd.com.service.ProduceCommandDVO"
		resultType="mes.prd.com.service.ProduceCommandDVO">
		SELECT * FROM (
		SELECT A.*, ROWNUM RNUM FROM (
		select f.*, p.prc_name
		from process_flow F, process P
		where f.prc_code = p.prc_code
		and itm_code = #{itmCode}
		<if test="prcFNo != null and prcFNo != ''">
			<![CDATA[	
				and prc_f_no > #{prcFNo}
			]]>
		</if>
		ORDER BY prc_f_no
		
		<![CDATA[					
		) A WHERE ROWNUM <= 10)
		]]>
	</select>
	
	<!-- 작업지시 grid 행 insert -->
	<insert id="insertProduceCommandD">
		declare
		v_matCode item.mat_code%type;
		begin
			select mat_code into v_matCode
			from item
			where itm_code = #{itmCode};
		
			insert into Produce_Command_D
				(prd_com_d_num, prd_com_num, itm_code, mat_code, prd_com_vol, prd_com_d_date, prc_com_no, prc_com_div, prd_com_d_note) 
				values(
					Produce_Command_D_seq.nextval,
					#{prdComNum},
					#{itmCode},
					v_matCode,
					#{prdComVol},
					to_date(#{prdComDDate1},'YYYY-MM-DD'),
					#{prcComNo},
					#{prcComDiv},
					#{prdComDNote}
				);
			end;
	</insert>
	
	<!-- 작업지시 master update -->
	<update id="updateProduceCommand">
		update Produce_Command set 
			prd_com_date = to_date(#{prdComDate},'yyyy-MM-dd'),
			prd_com_name = #{prdComName},
			prd_com_note = #{prdComNote}
		where prd_com_num = #{prdComNum}
	</update>
	
	<!-- 작업지시 grid 행 update -->
	<update id="updateProduceCommandD">
		update Produce_Command_D set 
			itm_code = #{itmCode},
			prd_com_vol = #{prdComVol},
			prd_com_d_date = to_date(#{prdComDDate1},'YYYY-MM-DD'),
			prc_com_no = #{prcComNo},
			prc_com_div = #{prcComDiv},
			prd_com_d_note = #{prdComDNote}
		where prd_com_d_num = #{prdComDNum}
	</update>
	
	<!-- 작업지시 grid 행 delete -->
	<delete id="deleteProduceCommandD">
		delete from Produce_Command_D 
		where prd_com_d_num = #{prdComDNum}
	</delete>

</mapper>
