<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mes.mat.stc.service.impl.MaterialStockMapper">
	

	<!-- <resultMap id="materialStock" type="mes.mat.stc.service.MaterialStockVO">
		<result property="lotNum" column="LOT_NUM" />
		<result property="matCode" column="MAT_CODE" />
		<result property="matVol" column="MAT_VOL" />
		<result property="matName" column="MAT_NAME" />
		<result property="matDiv" column="MAT_DIV" />
		<result property="matSafeStock" column="MAT_SAFE_STOCK" />
		<result property="matHisDVol" column="MAT_HIS_D_VOL" />
		<result property="matHisNum" column="MAT_HIS_NUM"/>
		<result property="matHisDate" column="MAT_HIS_DATE"/>
	</resultMap> -->
	
	<insert id="insertMaterialStock">
		<![CDATA[
			INSERT INTO MATERIAL_STOCK 
				( LOT_NUM
				  , MAT_CODE
				  , MAT_VOL )
			VALUES ( #{lotNum}
				  , #{matCode}
				  , #{matVol} )
		]]>
	</insert>
	
	<update id="updateMaterialStock">
		<![CDATA[
			UPDATE MATERIAL_STOCK
			SET LOT_NUM=#{lotNum}
				, MAT_CODE=#{matCode}
				, MAT_VOL=#{matVol}
						WHERE LOT_NUM=#{lotNum}
								AND MAT_CODE=#{matCode}
				]]>
	</update>
	
	<delete id="deleteMaterialStock">
		<![CDATA[
			DELETE FROM MATERIAL_STOCK 
						WHERE LOT_NUM=#{lotNum}
								AND MAT_CODE=#{matCode}
				]]>
	</delete>
	
	<select id="selectMaterialStock" resultType="mes.mat.stc.service.MaterialStockVO">
		<![CDATA[
			SELECT
				LOT_NUM
				, MAT_CODE
				, MAT_VOL
			FROM MATERIAL_STOCK
						WHERE LOT_NUM=#{lotNum}
								AND MAT_CODE=#{matCode}
				]]>
	</select>
	
	<select id="selectMatStcList" parameterType="mes.mat.stc.service.MaterialStockVO" resultType="mes.mat.stc.service.MaterialStockVO">
SELECT * FROM (
	SELECT A.*, ROWNUM RNUM FROM (
				select b.* , nvl(c.MAT_HIS_D_VOL, 0) as out
				from (select m.mat_code, 
				      m.mat_name, 
				      m.mat_div, 
				      sa.MAT_SAFE_STOCK, 
				      st.mat_vol, 
				      (sa.mat_safe_stock - st.mat_vol) as mShort, 
				      nvl(mhd.mat_his_d_vol, 0) as mat_his_d_vol
				from material m, material_safe sa, material_stock st, material_history mh, material_history_d mhd
				where m.mat_code=sa.mat_code 
				  AND M.MAT_CODE=ST.MAT_CODE 
				  and m.mat_code=mhd.mat_code 
				  and mh.mat_his_num=mhd.mat_his_num 
				  and MH.mat_his_div='입고'
			  	<if test="str != null and str != ''"> AND
				  	<![CDATA[
					M.MAT_CODE IN ('${str}')
					]]>
				</if>
				  and mh.mat_his_date BETWEEN TO_DATE('2021-06-09', 'YYYY-MM-DD') AND TO_DATE('2021-06-24', 'YYYY-MM-DD')
				  ) b left outer join
				  (select mat_code, MAT_HIS_D_VOL from material_history_d mhd, material_history mh
				  where mh.mat_his_num=mhd.mat_his_num 
				  and mh.mat_his_div='출고' 
			  	<if test="str != null and str != ''"> AND
				  	<![CDATA[
					MHD.MAT_CODE IN ('${str}')
					]]>
				</if>
				  and mh.mat_his_date BETWEEN TO_DATE('2021-06-09', 'YYYY-MM-DD') AND TO_DATE('2021-06-24', 'YYYY-MM-DD')) c
				  on c.mat_code = b.mat_code
		<![CDATA[					
	) A WHERE ROWNUM <= 10
)
]]>
	</select>	
	<!-- 자재 재고 조회 -->
	
	<select id="selectMatLotStcList" parameterType="mes.mat.stc.service.MaterialStockVO" resultType="egovMap">
		SELECT * FROM (
		SELECT A.*, ROWNUM RNUM FROM (
			SELECT M.MAT_CODE, 
			       M.MAT_NAME, 
			       M.MAT_SIZE, 
			       M.MAT_UNIT, 
			       MHD.LOT_NO, 
			       MHD.MAT_HIS_D_VOL,
			       ST.MAT_VOL
		FROM MATERIAL M, MATERIAL_STOCK ST, MATERIAL_HISTORY_D MHD
		WHERE M.MAT_CODE=MHD.MAT_CODE 
			  AND M.MAT_CODE=ST.MAT_CODE
			<if test="searchKeyword != null and searchKeyword != ''">
					<if test="searchCondition == 0">AND
						M.MAT_NAME = #{searchKeyword}
					</if>
					<if test="searchCondition == 1">AND
						M.MAT_CODE LIKE '%' || #{searchKeyword} || '%'
					</if>
				</if>   
					ORDER BY 
						M.MAT_CODE DESC
		
		<![CDATA[					
	) A WHERE ROWNUM <= 10
)
]]>
	</select>
	<!-- 자재 LOT 재고 조회 -->
	
	<select id="selectMaterialStockListTotCnt" parameterType="mes.mat.stc.service.MaterialStockVO" resultType="int">
			SELECT COUNT(*) totcnt
			FROM MATERIAL_STOCK
			WHERE 1=1
			<if test="searchKeyword != null and searchKeyword != ''">
				<if test="searchCondition == 0">AND
					LOT_NUM = #{searchKeyword}
				</if>
				<if test="searchCondition == 1">AND
					MAT_CODE LIKE '%' || #{searchKeyword} || '%'
				</if>
			</if>
	</select>
	
	<!-- 자재 코드 검색 -->
<!-- 	<select id="selectMatCodeList" parameterType="mes.mat.stc.service.MaterialStockVO" resultType="egovMap"> -->
<!-- 		select mat_code, mat_name, mat_size, mat_unit  -->
<!-- 		from material -->
<!-- 	</select> -->
	
	<!-- 자재 코드 모달 검색 -->
	<select id="selectMatCodeList" parameterType="mes.mat.stc.service.MaterialStockVO" resultType="egovMap">
		SELECT * FROM (
		SELECT A.*, ROWNUM RNUM FROM (
			SELECT MAT_CODE, 
			       MAT_NAME, 
			       MAT_SIZE, 
			       MAT_UNIT
			FROM MATERIAL
		<where>
			<if test="matCode != null and matCode != ''">
				<![CDATA[		
					MAT_CODE = #{matCode} 
				]]>
			</if>
			<if test="matName != null and matName != ''"> 
				<![CDATA[		
					AND MAT_NAME LIKE '%' || #{matName} || '%'
				]]>
			</if>
		</where>
			      
		<![CDATA[					
	) A WHERE ROWNUM <= 10
)
]]>
	</select>
	
</mapper>
