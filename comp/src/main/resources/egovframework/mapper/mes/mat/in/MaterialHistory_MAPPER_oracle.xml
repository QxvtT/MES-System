<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mes.mat.in.service.impl.MaterialHistoryMapper">
	
	<select id="selectMaterialHistory" resultType="mes.mat.in.service.MaterialHistoryVO">
		<![CDATA[
			SELECT
				MAT_HIS_NUM
				, MAT_HIS_DIV
				, MAT_HIS_DATE
				, MAT_OUT
				, MAT_HIS_VOL
			FROM MATERIAL_HISTORY
						WHERE MAT_HIS_NUM=#{matHisNum}
				]]>
	</select>
	
	<!-- 자재 입고 조회 -->
	<select id="selectMatInList" parameterType="mes.mat.in.service.MaterialHistoryVO" resultType="mes.mat.in.service.MaterialHistoryVO">
SELECT * FROM (
	SELECT A.*, ROWNUM RNUM FROM ( 
				SELECT MH.MAT_HIS_DATE, 
				       M.MAT_CODE, 
				       M.MAT_NAME,
				       M.MAT_SIZE, 
				       MH.MAT_ORD_OPER,
				       MHD.MAT_HIS_D_NUM,
				       MHD.MAT_COM_NUM,
				       MHD.MAT_HIS_D_VOL, 
				       MHD.MAT_HIS_PRICE, 
				       (MHD.MAT_HIS_D_VOL * MHD.MAT_HIS_PRICE) AS AMOUNT, 
				       MHD.LOT_Num,
				       MHD.MAT_HIS_NUM
				FROM MATERIAL M, MATERIAL_HISTORY_D MHD, MATERIAL_HISTORY MH, OPERATION O
				WHERE M.MAT_CODE = MHD.MAT_CODE 
				      AND MH.MAT_HIS_NUM = MHD.MAT_HIS_NUM
				      AND M.OPER_CODE = O.OPER_CODE
				      AND MH.MAT_HIS_DIV='입고'
				      <if test= "matHisNum != null and matHisNum != ''">
				      		and mhd.mat_his_num = #{matHisNum}
				      </if> 
				      <if test="matHisDNum1 != null and matHisDNum1 != ''">
				      <![CDATA[	
				      		and MHD.MAT_HIS_D_NUM < #{matHisDNum1}
				      ]]>
				      </if>
			     <if test="matHisDateS != null and matHisDateS != '' and matHisDateE != null and matHisDateE != ''"> AND
			     <![CDATA[			    			
	            			MH.MAT_HIS_DATE >= TO_DATE(#{matHisDateS} ,'yyyy-MM-dd') and  
	            			MH.MAT_HIS_DATE <= TO_DATE(#{matHisDateE} ,'yyyy-MM-dd')
      			]]>
			     </if>
			     <if test="matCodeList != null">
			     <if test="matCodeList.size != 0">
				      AND M.MAT_CODE IN 
			     	<foreach item="item" index="index" collection="matCodeList"
					      open="(" separator="," close=")">
					        #{item}
					</foreach>
			     </if>
			     </if>
			     <if test="operCode != null and operCode != ''">
				      AND O.OPER_CODE IN (${operCode})
			     </if>
			     order by MHD.MAT_HIS_D_NUM desc
		<![CDATA[					
	) A WHERE ROWNUM <= 10
)
]]>
	</select>	
	<!-- END 자재 입고 조회 -->
	
	<!-- 자재 입고 관리 조회 -->
	<select id="selectMatInMng" parameterType="mes.mat.in.service.MaterialHistoryVO" resultType="mes.mat.in.service.MaterialHistoryVO">
SELECT * FROM (
	SELECT A.*, ROWNUM RNUM FROM (
				SELECT TO_CHAR(MH.MAT_HIS_DATE, 'yyyy-MM-dd') as MAT_HIS_DATE, 
				       M.MAT_CODE, 
				       M.MAT_NAME,
				       M.MAT_SIZE,
				       M.MAT_UNIT,  
				       MHD.MAT_COM_NUM,
				       MHD.MAT_HIS_D_VOL, 
				       MHD.MAT_HIS_PRICE, 
				       (MHD.MAT_HIS_D_VOL * MHD.MAT_HIS_PRICE) AS AMOUNT, 
				       MHD.LOT_Num,
				       MS.MAT_VOL,
				       MHD.MAT_HIS_NUM,
				       MHD.MAT_HIS_D_NUM
				FROM MATERIAL M, MATERIAL_HISTORY_D MHD, MATERIAL_HISTORY MH, MATERIAL_STOCK MS
				WHERE M.MAT_CODE = MHD.MAT_CODE 
				      AND MH.MAT_HIS_NUM = MHD.MAT_HIS_NUM
				      AND M.MAT_CODE = MS.MAT_CODE
 				      AND MHD.LOT_NUM = MS.LOT_NUM
				      AND MH.MAT_HIS_DIV='입고'
			     <if test="matHisNum != null and matHisNum != ''">
				      	and mh.mat_His_Num = #{matHisNum}
			     </if>
				 <if test= "matHisDNum1 != null and matHisDNum1 != ''">
			      		and mhd.mat_his_d_num > #{matHisDNum1}
			     </if>
			     <if test="sDate != null and sDate != '' and eDate != null and eDate != ''"> AND
				     <![CDATA[			    			
            			MH.MAT_HIS_DATE >= TO_DATE(#{sDate} ,'yyyy-MM-dd') and  
            			MH.MAT_HIS_DATE <= TO_DATE(#{eDate} ,'yyyy-MM-dd')
	       			]]>
			     </if>
			     <if test="operCodeList != null">
			     <if test="operCodeList.size != 0">
				      AND O.OPER_CODE IN 
			     	<foreach item="item" index="index" collection="operCodeList"
					      open="(" separator="," close=")">
					        #{item}
					</foreach>
			     </if>
			     </if>
		<![CDATA[					
	) A WHERE ROWNUM <= 10
)
]]>
	</select>
	<!-- END 자재 입고 관리 조회 -->
	
	<!-- 자재 미입고 조회 -->
	<select id="nordList" parameterType="mes.mat.in.service.MaterialHistoryVO" resultType="mes.mat.in.service.MaterialHistoryVO">
SELECT * FROM (
	SELECT A.*, ROWNUM RNUM FROM (
				SELECT TO_CHAR(MH.MAT_HIS_DATE, 'yyyy-MM-dd') as MAT_HIS_DATE,
				       M.MAT_CODE, 
				       M.MAT_NAME,
				       M.MAT_SIZE, 
				       M.MAT_UNIT, 
				       MHD.MAT_COM_NUM,
				       MHD.MAT_HIS_D_VOL, 
				       MHD.MAT_HIS_PRICE, 
				       (MHD.MAT_HIS_D_VOL * MHD.MAT_HIS_PRICE) AS AMOUNT, 
				       MHD.LOT_NUM,
				       MHD.MAT_HIS_NUM,
				       MHD.MAT_HIS_D_NUM,
				       MH.MAT_ORD_OPER,
				       O.OPER_CODE,
				       MS.MAT_VOL,
				       MO.MAT_NORD_VOL
				FROM  MATERIAL M
				    , MATERIAL_HISTORY_D MHD
				    , MATERIAL_HISTORY MH
				    , OPERATION O
				    , MATERIAL_STOCK MS
				    , MATERIAL_ORDER MO
				WHERE M.MAT_CODE = MHD.MAT_CODE
				      AND MH.MAT_HIS_NUM = MHD.MAT_HIS_NUM
				      AND MHD.LOT_NUM = MS.LOT_NUM
				      AND M.OPER_CODE = O.OPER_CODE
				      AND M.MAT_CODE = MS.MAT_CODE
				      AND MO.MAT_COM_NUM = MHD.MAT_COM_NUM
				      AND MH.MAT_HIS_DIV='입고'
				      AND MO.MAT_NORD_VOL > 0
				 <if test= "matHisDNum1 != null and matHisDNum1 != ''">
			      		and mhd.mat_his_d_num > #{matHisDNum1}
			     </if>
			     <if test="matComDateS != null and matComDateS != '' and matComDateE != null and matComDateE != ''"> AND
				     <![CDATA[			    			
            			MO.MAT_COM_DATE >= TO_DATE(#{matComDateS} ,'yyyy-MM-dd') and  
            			MO.MAT_COM_DATE <= TO_DATE(#{matComDateE} ,'yyyy-MM-dd')
	       			]]>
			     </if>
		<![CDATA[	
		ORDER BY MHD.MAT_HIS_D_NUM				
	) A WHERE ROWNUM <= 10
)
]]>
	</select>
	<!-- END 자재 미입고 조회 -->
	
		<!-- 자재 출고 관리 조회 -->
	<select id="selectMatOutMng" parameterType="mes.mat.in.service.MaterialHistoryVO" resultType="egovMap">
SELECT * FROM (
	SELECT A.*, ROWNUM RNUM FROM (
				SELECT TO_CHAR(MH.MAT_HIS_DATE, 'yyyy-MM-DD') as MAT_HIS_DATE,
				       M.MAT_CODE,
				       M.MAT_NAME,
				       M.MAT_SIZE,
				       MH.MAT_OUT,
				       P.PRC_CODE,
				       M.MAT_UNIT,
				       MHD.MAT_HIS_D_VOL,
				       MHD.LOT_Num,
				       MS.MAT_VOL,
				       MHD.MAT_HIS_NUM,
				       MHD.MAT_HIS_D_NUM
				FROM MATERIAL M, MATERIAL_HISTORY_D MHD, MATERIAL_STOCK MS, MATERIAL_HISTORY MH, PROCESS P
				WHERE M.MAT_CODE = MHD.MAT_CODE
				  AND M.MAT_CODE = MS.MAT_CODE
				  AND MH.MAT_HIS_NUM = MHD.MAT_HIS_NUM  
				  AND P.PRC_NAME = MH.MAT_OUT
				  AND MH.MAT_HIS_DIV='출고'
				 <if test="matHisNum != null and matHisNum != ''">
				      	and mh.mat_His_Num = #{matHisNum}
				      </if>
				 <if test= "matHisDNum1 != null and matHisDNum1 != ''">
			      		and mhd.mat_his_d_num > #{matHisDNum1}
			     </if>
			     <if test="sDate != null and sDate != '' and eDate != null and eDate != ''"> AND
				     <![CDATA[			    			
	           			MH.MAT_HIS_DATE >= TO_DATE(#{sDate} ,'yyyy-MM-dd') and  
	           			MH.MAT_HIS_DATE <= TO_DATE(#{eDate} ,'yyyy-MM-dd')
      				]]>
			     </if>
					
		<![CDATA[					
	) A WHERE ROWNUM <= 10
)
]]>
	</select> 
	<!-- END 자재 출고 관리 조회 -->
	
	<!-- 일 입고 자료 리스트 -->
	<select id="matInDayList" parameterType="mes.mat.in.service.MaterialHistoryVO" resultType="mes.mat.in.service.MaterialHistoryVO">
	SELECT * FROM (
		SELECT A.*, ROWNUM RNUM FROM (
			SELECT    TO_CHAR(mh.MAT_HIS_DATE, 'yyyy-MM-DD') as MAT_HIS_DATE
			        , MH.MAT_HIS_NUM
			        , MH.MAT_HIS_VOL
                    , MH.MAT_ORD_OPER
                    , O.OPER_CODE
			FROM  MATERIAL_HISTORY MH
				  , OPERATION O
			WHERE MH.MAT_ORD_OPER = O.OPER_NAME 
				  AND MH.MAT_HIS_DIV = '입고'
			<if test="matHisNum != null and matHisNum != ''">AND
				mat_his_num = #{matHisNum}
			</if>
			<if test="matHisNum1 != null and matHisNum1 != ''">AND
				mat_his_num > #{matHisNum1}
			</if>
			<if test="sDate != null and sDate != '' and eDate != null and eDate != ''"> AND
			     <![CDATA[			    			
         			MAT_HIS_DATE >= TO_DATE(#{sDate} ,'yyyy-MM-dd') and  
         			MAT_HIS_DATE <= TO_DATE(#{eDate} ,'yyyy-MM-dd')
				]]>
			</if>
			order by mat_his_num			
			<![CDATA[		
		) A WHERE ROWNUM <= 10
	)
	]]>
	</select>
	<!-- END 일 입고 자료 리스트 -->
	
	<!-- 일 출고 자료 리스트 -->
	<select id="matOutDayList" parameterType="mes.mat.in.service.MaterialHistoryVO" resultType="mes.mat.in.service.MaterialHistoryVO">
	SELECT * FROM (
		SELECT A.*, ROWNUM RNUM FROM (
			SELECT    TO_CHAR(mh.MAT_HIS_DATE, 'yyyy-MM-DD') as MAT_HIS_DATE
			        , MH.MAT_HIS_NUM
			        , MH.MAT_OUT
			        , MH.MAT_HIS_VOL
			        , P.PRC_CODE
			FROM  MATERIAL_HISTORY MH
				, PROCESS P
			WHERE MH.MAT_HIS_DIV = '출고'
			AND   MH.MAT_OUT = P.PRC_NAME
			<if test="matHisNum != null and matHisNum != ''">AND
				mat_his_num = #{matHisNum}
			</if>
			<if test="matHisNum1 != null and matHisNum1 != ''">
				and mh.mat_his_num > #{matHisNum1}
			</if>
			<if test="sDate != null and sDate != '' and eDate != null and eDate != ''"> AND
			     <![CDATA[			    			
         			MH.MAT_HIS_DATE >= TO_DATE(#{sDate} ,'yyyy-MM-dd') and  
         			MH.MAT_HIS_DATE <= TO_DATE(#{eDate} ,'yyyy-MM-dd')
				]]>
			</if>
			order by mat_his_num
			<![CDATA[	
			) A WHERE ROWNUM <= 10
		)
	]]>
	</select>
	<!-- END 일 출고 자료 리스트 -->
	
	<!-- 자재 입고 관리  master insert -->
	<insert id="insertMatInMng">
		INSERT INTO MATERIAL_HISTORY( MAT_HIS_NUM
		                            , MAT_HIS_DATE
		                            , MAT_ORD_OPER
		                            , MAT_HIS_DIV
		                            , MAT_HIS_VOL) 
		VALUES( #{matHisNum}
				, TO_DATE(#{matHisDate}, 'yyyy-MM-dd')
				, #{matOrdOper}
			 	, #{matHisDiv}
			 	, #{matHisVol})
	</insert>
	<!-- END 자재 입고 관리  master insert -->
	
	<!-- 자재 출고 관리  master insert -->
	<insert id="insertMatOutMng">
		INSERT INTO MATERIAL_HISTORY(MAT_HIS_NUM
		                            , MAT_HIS_DATE
		                            , MAT_OUT
		                            , MAT_HIS_DIV
		                            , MAT_HIS_VOL) 
		VALUES( #{matHisNum}
		, TO_DATE(#{matHisDate}, 'yyyy-MM-dd')
		, #{matOut}
		, #{matHisDiv}
		, #{matHisVol})
	</insert>
	<!-- END 자재 출고 관리  master insert -->
	
	<!-- 자재 입고 관리 master update -->
	<update id="updateMatInMng">
		<selectKey resultType="string" keyProperty="matOrdOper" order="BEFORE">
	        SELECT oper_name FROM operation   
	        where oper_code = #{operCode}   
	    </selectKey>
		UPDATE MATERIAL_HISTORY
		SET MAT_HIS_DATE = TO_DATE(#{matHisDate}, 'yyyy-MM-dd'),
			mat_ord_oper = #{matOrdOper}
		WHERE MAT_HIS_NUM = #{matHisNum}
	</update>
	<!-- END 자재 입고 관리 master update -->
	
	<!-- 자재 출고 관리 master update -->
	<update id="updateMatOutMng">
		<selectKey resultType="string" keyProperty="matOut" order="BEFORE">
	        SELECT prc_name FROM process   
	        where prc_code = #{prcCode}   
	    </selectKey>
		UPDATE MATERIAL_HISTORY
		SET MAT_HIS_DATE = TO_DATE(#{matHisDate}, 'yyyy-MM-dd'),
			MAT_OUT = #{matOut}
		WHERE MAT_HIS_NUM = #{matHisNum}
	</update>
	<!-- END 자재 출고 관리 master update -->
	
	<!-- 자재 입고 관리 grid 행 insert -->
	<insert id="insertMatInMngD">
		insert into material_history_d
			(mat_his_d_num
			, mat_his_num
			, mat_code
			, mat_his_d_vol
			, mat_his_price)
			values(
				material_history_seq.nextval,
				#{matHisNum},
				#{matCode},
				#{matHisDVol},
				#{matHisPrice}
			)
	</insert>
	<!-- END 자재 입고 관리 grid 행 insert -->
	
	<!-- 자재 출고 관리 grid 행 insert -->
	<insert id="insertMatOutMngD">
		insert into material_history_d
			(mat_his_d_num
			, mat_his_num
			, mat_code
			, mat_his_d_vol)
			values(
				material_history_seq.nextval,
				#{matHisNum},
				#{matCode},
				#{matHisDVol}
			)
	</insert>
	<!-- END 자재 출고 관리 grid 행 insert -->
	
	<!-- 자재 입고 관리 grid 행 update -->
	<update id="updateMatInMngD">
		UPDATE MATERIAL_HISTORY_D SET 
			MAT_CODE = #{matCode},
			MAT_HIS_D_VOL = #{matHisDVol},
			MAT_HIS_PRICE = #{matHisPrice}
		WHERE MAT_HIS_D_NUM = #{matHisDNum}
	</update>
	<!-- END 자재 입고 관리 grid 행 update -->
	
	<!-- 자재 출고 관리 grid 행 update -->
	<update id="updateMatOutMngD">
		UPDATE MATERIAL_HISTORY_D SET 
			MAT_CODE = #{matCode},
			MAT_HIS_D_VOL = #{matHisDVol}
		WHERE MAT_HIS_D_NUM = #{matHisDNum}
	</update>
	<!-- END 자재 입고 관리 grid 행 update -->
	
	<!-- 작업지시 grid 행 delete -->
	<delete id="deleteMatInMngD">
		delete from MATERIAL_HISTORY_D 
		where MAT_HIS_D_NUM = #{matHisDNum}
	</delete>
	<!-- END 작업지시 grid 행 delete -->
	
	<!-- 자재 입고 관리 마스터번호 구하기 -->
	<select id="getMatInMngCount" resultType="int">
		select nvl(to_number(max(substr(mat_com_num,11))),0) + 1
		from material_history
		where to_char(mat_his_date,'yyyy-MM-dd') = #{matHisDate}
	</select>
	<!-- END 자재 입고 관리 마스터번호 구하기 -->
	
	<!-- 자재 출고 관리 마스터번호 구하기 -->
	<select id="getMatOutMngCount" resultType="int">
		select nvl(to_number(max(substr(mat_com_num,11))),0) + 1
		from material_history
		where to_char(mat_his_date,'yyyy-MM-dd') = #{matHisDate}
	</select>
	<!-- END 자재 출고 관리 마스터번호 구하기 -->
</mapper>
