<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mes.mat.in.service.impl.MaterialHistoryMapper">
	
	<!-- 자재 입고 등록 -->
	<insert id="insertMatIn">
		
	</insert>
	
	<!-- 자재 입고 수정 -->
	<update id="updateMatIn">
		UPDATE MATERIAL_HISTORY_D
		SET  MAT_CODE = #{matCode}
			,MAT_HIS_D_VOL = #{matHisDVol}
			,MAT_HIS_PRICE = #{matHisPrice}
		WHERE MAT_HIS_D_NUM = #{matHisDNum}
	</update>
	
	<!-- 자재 입고 삭제 -->
	<delete id="deleteMatIn">
		<![CDATA[
			DELETE FROM MATERIAL_HISTORY_D MHD 
			WHERE EXISTS
			    (SELECT 1 FROM MATERIAL_HISTORY MH 
			     WHERE MHD.MAT_HIS_NUM = MH.MAT_HIS_NUM
			     AND MHD.MAT_HIS_NUM = #{matHisNum}
			     AND MH.MAT_HIS_NUM = #{matHisNum}
			     AND MH.MAT_HIS_DIV = '입고')
				]]>
	</delete>
	
	<select id="selectMaterialHistory" resultType="mes.mat.in.service.MaterialHistoryVO">
		<![CDATA[
			SELECT
				MAT_HIS_NUM
				, MAT_HIS_DIV
				, MAT_HIS_DATE
				, MAT_OUT
				, MAT_HIS_VOL
			FROM MATERIAL_HISTORY
						WHERE MAT_HIS_NUM=#{matHisNum}
				]]>
	</select>
	
	<select id="selectMatInList" parameterType="mes.mat.in.service.MaterialHistoryVO" resultType="mes.mat.in.service.MaterialHistoryVO">
SELECT * FROM (
	SELECT A.*, ROWNUM RNUM FROM (
				SELECT MH.MAT_HIS_DATE, 
				       M.MAT_CODE, 
				       M.MAT_NAME,
				       M.MAT_SIZE, 
				       MHD.MAT_OUT_OPER,
				       MHD.MAT_COM_NUM,
				       MHD.MAT_HIS_D_VOL, 
				       MHD.MAT_HIS_PRICE, 
				       (MHD.MAT_HIS_D_VOL * MHD.MAT_HIS_PRICE) AS AMOUNT, 
				       MHD.LOT_NO,
				       MHD.MAT_HIS_NUM
				FROM MATERIAL M, MATERIAL_HISTORY_D MHD, MATERIAL_HISTORY MH, OPERATION O
				WHERE M.MAT_CODE = MHD.MAT_CODE 
				      AND MH.MAT_HIS_NUM = MHD.MAT_HIS_NUM
				      AND M.OPER_CODE = O.OPER_CODE
				      AND MH.MAT_HIS_DIV='입고'
			     <if test="matHisDateS != null and matHisDateS != '' and matHisDateE != null and matHisDateE != ''"> AND
			     <![CDATA[			    			
	            			MH.MAT_HIS_DATE >= TO_DATE(#{matHisDateS} ,'yyyy-MM-dd') and  
	            			MH.MAT_HIS_DATE <= TO_DATE(#{matHisDateE} ,'yyyy-MM-dd')
	            			]]>
			     </if>
			     <if test="matCodeList != null">
			     <if test="matCodeList.size != 0">
				      AND M.MAT_CODE IN 
			     	<foreach item="item" index="index" collection="matCodeList"
					      open="(" separator="," close=")">
					        #{item}
					</foreach>
			     </if>
			     </if>
			     <if test="operCode != null and operCode != ''">
				      AND O.OPER_CODE IN (${operCode})
			     </if>
				<if test="searchKeyword != null and searchKeyword != ''">
					<if test="searchCondition == 0">AND
						M.MAT_NAME = #{searchKeyword}
					</if>
					<if test="searchCondition == 1">AND
						M.MAT_NAME '%' || #{searchKeyword} || '%'
					</if>
				</if>
					
		<![CDATA[					
	) A WHERE ROWNUM <= 10
)
]]>
	</select>	
	<!-- END 자재 입고 조회 -->
	
		<select id="selectMatOutMng" parameterType="mes.mat.in.service.MaterialHistoryVO" resultType="egovMap">
SELECT * FROM (
	SELECT A.*, ROWNUM RNUM FROM (
				SELECT M.MAT_CODE,
				       M.MAT_NAME,
				       M.MAT_SIZE,
				       M.MAT_UNIT,
				       MHD.MAT_HIS_D_VOL,
				       MHD.LOT_NO,
				       MS.MAT_VOL
				FROM MATERIAL M, MATERIAL_HISTORY_D MHD, MATERIAL_STOCK MS, MATERIAL_HISTORY MH
				WHERE M.MAT_CODE = MHD.MAT_CODE
				  AND M.MAT_CODE = MS.MAT_CODE
				  AND MH.MAT_HIS_NUM = MHD.MAT_HIS_NUM  
				  AND MH.MAT_HIS_DIV='출고'
				  AND MH.MAT_HIS_DATE BETWEEN TO_DATE('2021-06-09', 'YYYY-MM-DD') AND TO_DATE('2021-06-25', 'YYYY-MM-DD')
				<if test="searchKeyword != null and searchKeyword != ''">
					<if test="searchCondition == 0">AND
						M.MAT_NAME = #{searchKeyword}
					</if>
					<if test="searchCondition == 1">AND
						M.MAT_NAME '%' || #{searchKeyword} || '%'
					</if>
				</if>
					
		<![CDATA[					
	) A WHERE ROWNUM <= 10
)
]]>
	</select> 
	<!-- END 자재 출고 관리 조회 -->
	
	<select id="selectMatInMng" parameterType="mes.mat.in.service.MaterialHistoryVO" resultType="mes.mat.in.service.MaterialHistoryVO">
SELECT * FROM (
	SELECT A.*, ROWNUM RNUM FROM (
				SELECT MH.MAT_HIS_DATE, 
				       M.MAT_CODE, 
				       M.MAT_NAME,
				       M.MAT_SIZE, 
				       MHD.MAT_OUT_OPER,
				       MHD.MAT_COM_NUM,
				       MHD.MAT_HIS_D_VOL, 
				       MHD.MAT_HIS_PRICE, 
				       (MHD.MAT_HIS_D_VOL * MHD.MAT_HIS_PRICE) AS AMOUNT, 
				       MHD.LOT_NO,
				       MHD.MAT_HIS_NUM
				FROM MATERIAL M, MATERIAL_HISTORY_D MHD, MATERIAL_HISTORY MH, OPERATION O
				WHERE M.MAT_CODE = MHD.MAT_CODE 
				      AND MH.MAT_HIS_NUM = MHD.MAT_HIS_NUM
				      AND M.OPER_CODE = O.OPER_CODE
				      AND MH.MAT_HIS_DIV='입고'
			     <if test="matHisDateS != null and matHisDateS != '' and matHisDateE != null and matHisDateE != ''"> AND
			     <![CDATA[			    			
	            			MH.MAT_HIS_DATE >= TO_DATE(#{matHisDateS} ,'yyyy-MM-dd') and  
	            			MH.MAT_HIS_DATE <= TO_DATE(#{matHisDateE} ,'yyyy-MM-dd')
	            			]]>
			     </if>
			     <if test="operCodeList != null">
			     <if test="operCodeList.size != 0">
				      AND O.OPER_CODE IN 
			     	<foreach item="item" index="index" collection="operCodeList"
					      open="(" separator="," close=")">
					        #{item}
					</foreach>
			     </if>
			     </if>

				<if test="searchKeyword != null and searchKeyword != ''">
					<if test="searchCondition == 0">AND
						M.MAT_NAME = #{searchKeyword}
					</if>
					<if test="searchCondition == 1">AND
						M.MAT_NAME '%' || #{searchKeyword} || '%'
					</if>
				</if>
					
		<![CDATA[					
	) A WHERE ROWNUM <= 10
)
]]>
	</select>
	<!-- END 자재 입고 관리 조회 -->
	
	<select id="selectMaterialHistoryListTotCnt" parameterType="mes.mat.in.service.MaterialHistoryVO" resultType="int">
			SELECT COUNT(*) totcnt
			FROM MATERIAL_HISTORY
			WHERE 1=1
			<if test="searchKeyword != null and searchKeyword != ''">
				<if test="searchCondition == 0">AND
					MAT_HIS_NUM = #{searchKeyword}
				</if>
				<if test="searchCondition == 1">AND
					MAT_HIS_DIV LIKE '%' || #{searchKeyword} || '%'
				</if>
			</if>
	</select>
	
	<!-- 일 입고 자료 리스트 -->
	<select id="matInDayList" parameterType="mes.mat.in.service.MaterialHistoryVO" resultType="mes.mat.in.service.MaterialHistoryVO">
			SELECT    MH.MAT_HIS_DATE
			        , MH.MAT_HIS_NUM
			        , MHD.MAT_OUT_OPER
			        , MH.MAT_HIS_VOL
			        , O.OPER_CODE
			FROM  MATERIAL_HISTORY MH
			    , MATERIAL_HISTORY_D MHD
			    , OPERATION O
			WHERE MH.MAT_HIS_NUM = MHD.MAT_HIS_NUM
			AND   O.OPER_NAME = MHD.MAT_OUT_OPER
			<if test="sDate != null and sDate != '' and eDate != null and eDate != ''"> AND
			     <![CDATA[			    			
         			MH.MAT_HIS_DATE >= TO_DATE(#{sDate} ,'yyyy-MM-dd') and  
         			MH.MAT_HIS_DATE <= TO_DATE(#{eDate} ,'yyyy-MM-dd')
				]]>
			</if>
			<if test="operCode != null and operCode != ''"> AND
			     <![CDATA[			    			
         			O.OPER_CODE = #{operCode}
				]]>
			</if>
	</select>

</mapper>
